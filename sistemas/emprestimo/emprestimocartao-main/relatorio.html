<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body {
    background-color: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
header img.logo { height: 50px; }
header h1 {
    flex-grow:1;
    font-size: 1.5rem;
    color: #00ff7f;
}
header button {
    padding:5px 10px;
    border-radius:5px;
    border:none;
    cursor:pointer;
    background:#00ff7f;
    color:#111;
}
main { display: flex; gap: 20px; }

/* ===== Estoque ===== */
#estoque {
    width: 400px;              /* mais largo para não cortar */
    background: #1e1e1e;
    padding: 15px;
    border-radius: 10px;
    color: #e0e0e0;
    height: fit-content;
}
#estoque h2 {
    color: #00ff7f;
    font-size: 1.1rem;
    margin-bottom: 10px;
}
#estoqueConteudo {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.cardEstoque {
    background: #2a2a2a;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
}
.cardEstoque h3 {
    margin: 0;
    font-size: 1rem;
    color: #00b894;
}
.cardEstoque p {
    margin: 3px 0;
    font-size: 0.9rem;
}

/* Atenção piscante ⚠️ */
.attention {
    display:inline-block;
    margin-left:6px;
    animation: blink 1s infinite;
}
@keyframes blink {
    0%,50%,100% { opacity:1; }
    25%,75% { opacity:0; }
}

.controls-bar {
    display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap;
}
#monthSelect, .filterTipoBtn, #cardNumberFilter, #matriculaFilter, .countBtn {
    font-weight:600;
    border-radius:8px;
    padding:6px 10px;
    border:1px solid rgba(255,255,255,0.06);
    background:#222;
    color:#fff;
    cursor:pointer;
}
.count-filters { display:flex; gap:8px; align-items:center; }
.count-filters label { font-size:0.9rem; display:flex; gap:6px; align-items:center; }
.countBtn.inactive { background:#111; color:#888; }
.legend { margin-left:auto; display:flex; gap:10px; align-items:center; font-size:0.9rem; }
.legend .item { display:flex; gap:8px; align-items:center; }

.table-wrap { flex:1; }
table {
    flex: 1;
    width: 100%;
    border-collapse: collapse;
    background: #1f1f1f;
    border-radius: 8px;
    overflow: hidden;
}
th, td {
    padding: 5px;
    text-align: left;
    border-bottom: 1px solid #333;
    font-size: 0.95rem;
    color: #e0e0e0;
}
th { background-color: #00ff7f; color: #111; }
tr:hover { background-color: #333; }
.statusBtn {
    padding:5px 25px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    color:#111;
    font-weight: bold;
}
td.matricula {
    font-weight: bold;
    text-align: center;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    padding-top:10px;
    padding-bottom:10px;
}
.badge-type {
    padding:4px 8px;
    border-radius:999px;
    font-size:0.78rem;
    font-weight:700;
    box-shadow: 0 2px 6px rgba(0,0,0,0.45);
}
.legend-swatch { width:16px; height:12px; border-radius:4px; display:inline-block; }
.table-bottom-spacer { height: 70px; }
.footer { margin-top:18px; color:#888; text-align:center; }

@media(max-width:900px){
    main { flex-direction:column; }
    #estoque { width:100%; }
}
</style>
</head>
<body>
<header>
<img src="logo.png" alt="Logo" class="logo">
<h1>Relatório de Empréstimos</h1>
<button onclick="window.location.href='index.html'">🏠 Voltar</button>
</header>

<main>
<aside id="estoque">
<h2>📦 Estoque</h2>
<div id="estoqueConteudo">Carregando...</div>
</aside>

<div class="table-wrap">
<div id="controlsHolder"></div>
<table id="relatorioTable">
<thead>
<tr>
<th>Nome</th>
<th>Matrícula</th>
<th>Tipo Cartão</th>
<th>N° Bordo Digicon</th>
<th>N° Bordo Prodata</th>
<th>N° Meia Viagem</th>
<th>Motivo</th>
<th>Matrícula Empréstimo</th>
<th>Data Retirada</th>
<th>Prazo Devolução</th>
<th>Status</th>
</tr>
</thead>
<tbody id="relatorioBody"></tbody>
</table>
<div class="table-bottom-spacer" aria-hidden="true"></div>
</div>
</main>

<script src="firebaseConfig.js"></script>
<script>
/* ---------- Helpers ---------- */
function parseDate(str) { if(!str) return null; const parts = str.split('/'); if(parts.length !== 3) return null; return new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0])); }
function getTipoNormalizado(tipoStr){
    const t=(tipoStr||'').toLowerCase();
    if(t.includes('digicon')) return 'digicon';
    if(t.includes('prodata')) return 'prodata';
    if(t.includes('meia')) return 'meia';
    return t;
}

/* ---------- Badges e atenção ---------- */
function addBadges(tdMat, matCounts){
    const badgesWrap=document.createElement('div');
    badgesWrap.style.display='flex';
    badgesWrap.style.gap='6px';
    badgesWrap.style.justifyContent='center';
    badgesWrap.style.marginTop='4px';

    const createBadge=(label,count,color)=>{
        const b=document.createElement('span');
        b.className='badge-type';
        b.textContent=`${label}: ${count}`;
        b.style.background=color;
        b.style.color='#111';
        return b;
    };

    const colorDigicon = matCounts.digicon>=4?'#e74c3c':matCounts.digicon===3?'#f5b041':matCounts.digicon===2?'#f9e79f':'#bcd9a8';
    const colorProdata = matCounts.prodata>=4?'#ff6b6b':matCounts.prodata===3?'#ffb86b':matCounts.prodata===2?'#ffeaa7':'#a0e7e5';
    const colorMeia = matCounts.meia>=4?'#d980fa':matCounts.meia===3?'#c77dff':matCounts.meia===2?'#e7c6ff':'#d1c7ff';

    if(matCounts.digicon>0) badgesWrap.appendChild(createBadge('Dig',matCounts.digicon,colorDigicon));
    if(matCounts.prodata>0) badgesWrap.appendChild(createBadge('Pro',matCounts.prodata,colorProdata));
    if(matCounts.meia>0) badgesWrap.appendChild(createBadge('Meia',matCounts.meia,colorMeia));

    tdMat.appendChild(badgesWrap);

    const totalCards = matCounts.digicon + matCounts.prodata + matCounts.meia;
    if(totalCards > 2){
        const att = document.createElement('span');
        att.className = 'attention';
        att.textContent = '⚠️';
        tdMat.appendChild(att);
    }
}

/* ---------- Status ---------- */
function addStatusListener(tr,id,data){
    const btn=tr.querySelector('.statusBtn');
    btn.addEventListener('click', async ()=>{
        const novoStatus = data.status==='em aberto'?'resolvido':'em aberto';
        await db.collection('emprestimos').doc(id).update({status:novoStatus});
        data.status = novoStatus;
        btn.textContent = novoStatus;
        btn.style.background = novoStatus==='em aberto'?'#ff5555':'#55ff55';
    });
}

/* ---------- Estoque ---------- */
async function atualizarEstoque(){
    const estoqueDiv=document.getElementById("estoqueConteudo");
    estoqueDiv.innerHTML="Atualizando...";
    const total={digicon:10, prodata:10, meiaViagem:10};
    const emprestados={digicon:[], prodata:[], meiaViagem:[]};

    const snapshot=await db.collection("emprestimos").where("status","==","em aberto").get();
    snapshot.forEach(doc=>{
        const data=doc.data();
        const tipo=(data.tipoCartao||'').toLowerCase();
        if(tipo==='digicon' && data.numBordoDigicon) emprestados.digicon.push(Number(data.numBordoDigicon));
        if(tipo==='prodata' && data.numBordoProdata) emprestados.prodata.push(Number(data.numBordoProdata));
        if(data.numMeiaViagem) emprestados.meiaViagem.push(Number(data.numMeiaViagem));
    });

    function gerarLista(tipo){
        const chave=tipo;
        const todos=Array.from({length: total[chave]},(_,i)=>i+1);
        const disponiveis=todos.filter(n=>!emprestados[chave].includes(n));
        const titulo=chave==='digicon'?'Bordo Digicon':chave==='prodata'?'Bordo Prodata':'Meia Viagem';
        return `<div class="cardEstoque">
            <h3>${titulo}</h3>
            <p><b>Qtd. Disponível:</b> ${disponiveis.length}</p>
            <p><b>Qtd. Emprestado:</b> ${emprestados[chave].length}</p>
            <p><b>N° Disponíveis:</b> ${disponiveis.join(', ')||'-'}</p>
            <p><b>N° Emprestados:</b> ${emprestados[chave].join(', ')||'-'}</p>
        </div>`;
    }

    estoqueDiv.innerHTML=gerarLista("digicon")+gerarLista("prodata")+gerarLista("meiaViagem");
}

/* ---------- Controles ---------- */
function criarControles(){
    const container=document.createElement('div'); container.className='controls-bar';
    // Month select
    const monthSelect=document.createElement('select'); monthSelect.id='monthSelect';
    const current=new Date();
    for(let i=0;i<12;i++){
        const d=new Date(current.getFullYear(),current.getMonth()-i,1);
        const id=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const opt=document.createElement('option');
        opt.value=id;
        opt.textContent=d.toLocaleString('pt-BR',{month:'long',year:'numeric'});
        monthSelect.appendChild(opt);
    }

    // Tipo buttons
    const toggles=document.createElement('div'); toggles.style.display='flex'; toggles.style.gap='8px'; toggles.style.alignItems='center';
    ['digicon','prodata','meia'].forEach(key=>{
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='filterTipoBtn';
        btn.dataset.tipo=key;
        btn.textContent=key==='digicon'?'Digicon':key==='prodata'?'Prodata':'Meia';
        btn.dataset.active='true';
        toggles.appendChild(btn);
    });

    // Card number & matricula
    const cardNumberFilter=document.createElement('input');
    cardNumberFilter.type='number';
    cardNumberFilter.id='cardNumberFilter';
    cardNumberFilter.placeholder='Nº card';
    const matriculaFilter=document.createElement('input');
    matriculaFilter.type='text';
    matriculaFilter.id='matriculaFilter';
    matriculaFilter.placeholder='Matricula';

    // Count buttons
    const countFilters=document.createElement('div'); countFilters.className='count-filters';
    ['1','2','3','4+'].forEach(lbl=>{
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='countBtn';
        btn.dataset.count=lbl;
        btn.dataset.active='true';
        btn.textContent=lbl;
        countFilters.appendChild(btn);
    });

    // Legend
    const legend=document.createElement('div'); legend.className='legend';
    [{label:'1',color:'#bcd9a8'},{label:'2',color:'#f9e79f'},{label:'3',color:'#f5b041'},{label:'4+',color:'#e74c3c'}].forEach(t=>{
        const item=document.createElement('div'); item.className='item';
        const sw=document.createElement('span'); sw.className='legend-swatch'; sw.style.background=t.color;
        const lbl=document.createElement('span'); lbl.textContent=t.label;
        item.appendChild(sw); item.appendChild(lbl); legend.appendChild(item);
    });

    container.appendChild(monthSelect);
    container.appendChild(toggles);
    container.appendChild(cardNumberFilter);
    container.appendChild(matriculaFilter);
    container.appendChild(countFilters);
    container.appendChild(legend);

    document.getElementById('controlsHolder').appendChild(container);

    monthSelect.addEventListener('change',()=>carregarRelatorio());
    toggles.querySelectorAll('.filterTipoBtn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            btn.dataset.active=btn.dataset.active==='true'?'false':'true';
            btn.style.opacity=btn.dataset.active==='true'?'1':'0.45';
            const all=Array.from(toggles.querySelectorAll('.filterTipoBtn'));
            if(all.every(b=>b.dataset.active==='false')) all.forEach(b=>{b.dataset.active='true'; b.style.opacity='1';});
            carregarRelatorio();
        });
    });
    cardNumberFilter.addEventListener('input',()=>carregarRelatorio());
    matriculaFilter.addEventListener('input',()=>carregarRelatorio());
    countFilters.querySelectorAll('button.countBtn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            btn.dataset.active=btn.dataset.active==='true'?'false':'true';
            btn.classList.toggle('inactive',btn.dataset.active==='false');
            const all=Array.from(countFilters.querySelectorAll('button.countBtn'));
            if(all.every(b=>b.dataset.active==='false')) all.forEach(b=>{b.dataset.active='true'; b.classList.remove('inactive');});
            carregarRelatorio();
        });
    });
}

/* ---------- Relatório ---------- */
async function carregarRelatorio(){
    const tbody=document.getElementById('relatorioBody'); tbody.innerHTML='';
    const monthId=document.getElementById('monthSelect')?.value;
    const [y,m]=monthId.split('-').map(Number);
    const start=new Date(y,m-1,1,0,0,0,0);
    const end=new Date(y,m,0,23,59,59,999);

    const activeTipos=Array.from(document.querySelectorAll('.filterTipoBtn')).filter(b=>b.dataset.active==='true').map(b=>b.dataset.tipo);
    const cardNumberValue=(document.getElementById('cardNumberFilter')?.value||'').trim();
    const matriculaFilterValue=(document.getElementById('matriculaFilter')?.value||'').trim();
    const selectedCounts=Array.from(document.querySelectorAll('.countBtn')).filter(b=>b.dataset.active==='true').map(b=>b.dataset.count);

    const counts={}; const rows=[];
    try{
        const snapshot=await db.collection('emprestimos').orderBy('timestamp','desc').get();
        snapshot.forEach(docSnap=>{
            const data=docSnap.data();
            let docDate=data.timestamp?.toDate()||parseDate(data.dataRetirada);
            if(!docDate||docDate<start||docDate>end) return;
            const tipo=getTipoNormalizado(data.tipoCartao);
            if(!activeTipos.includes(tipo)) return;
            const mat=data.matriculaMotorista||data.matricula||'---';
            if(!counts[mat]) counts[mat]={digicon:0, prodata:0, meia:0};
            counts[mat][tipo]+=1;
            rows.push({id:docSnap.id,data,tipo,mat,docDate});
        });

        const filteredRows=rows.filter(r=>{
            const matCounts=counts[r.mat];
            const totalForActive=(activeTipos.includes('digicon')?matCounts.digicon:0)+(activeTipos.includes('prodata')?matCounts.prodata:0)+(activeTipos.includes('meia')?matCounts.meia:0);
            let label=totalForActive>=4?'4+':totalForActive.toString();
            if(!selectedCounts.includes(label)) return false;
            if(cardNumberValue!==''){
                const d=r.data;
                if(r.tipo==='digicon' && d.numBordoDigicon?.toString()!==cardNumberValue) return false;
                if(r.tipo==='prodata' && d.numBordoProdata?.toString()!==cardNumberValue) return false;
                if(r.tipo==='meia' && d.numMeiaViagem?.toString()!==cardNumberValue) return false;
            }
            if(matriculaFilterValue!=='' && !r.mat.includes(matriculaFilterValue)) return false;
            return true;
        });

        for(const r of filteredRows){
            const d=r.data;
            const tr=document.createElement('tr');
            tr.innerHTML=`
                <td>${d.nomeMotorista||''}</td>
                <td class="matricula">${r.mat}</td>
                <td>${d.tipoCartao||''}</td>
                <td>${d.numBordoDigicon||'-'}</td>
                <td>${d.numBordoProdata||'-'}</td>
                <td>${d.numMeiaViagem||'-'}</td>
                <td>${d.motivo||''}</td>
                <td>${d.matriculaEmpresto||''}</td>
                <td>${d.dataRetirada||''}</td>
                <td>${d.prazoDevolucao||'-'}</td>
                <td><button class="statusBtn" style="background:${d.status==='em aberto'?'#ff5555':'#55ff55'};">${d.status}</button></td>`;
            tbody.appendChild(tr);
            addBadges(tr.querySelector('td.matricula'),counts[r.mat]);
            addStatusListener(tr,r.id,d);
        }
    }catch(err){console.error(err); alert('Erro ao carregar relatório. Veja o console.');}
}

/* ---------- Inicialização ---------- */
criarControles();
carregarRelatorio();
atualizarEstoque();
</script>

<footer class="footer">Relatório atualizado em tempo real</footer>
</body>
</html>
