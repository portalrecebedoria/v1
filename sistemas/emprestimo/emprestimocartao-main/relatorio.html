<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatório de Empréstimos</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
/* (ESTILO ORIGINAL — NÃO ALTERADO) */
body {
    background-color: #121212;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}
header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}
header img.logo { height: 50px; }
header h1 {
    flex-grow:1;
    font-size: 1.5rem;
    color: #00ff7f;
}
header button {
    padding:5px 10px;
    border-radius:5px;
    border:none;
    cursor:pointer;
    background:#00ff7f;
    color:#111;
}
.statusBtn {
    padding:5px 25px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    color:#111;
    font-weight: bold;
}
.deleteBtn {
    padding:5px 10px;
    border:none;
    border-radius:5px;
    cursor:pointer;
    background:#ff4444;
    color:#fff;
    font-weight:bold;
}
</style>
</head>

<body>

<header>
<img src="logo.png" alt="Logo" class="logo">
<h1>Relatório de Empréstimos</h1>
<button onclick="window.location.href='index.html'">🏠 Voltar</button>
</header>

<main>
<div class="table-wrap">
<table id="relatorioTable">
<thead>
<tr>
<th>Nome</th>
<th>Matrícula</th>
<th>Tipo Cartão</th>
<th>N° Bordo Digicon</th>
<th>N° Bordo Prodata</th>
<th>N° Meia Viagem</th>
<th>Motivo</th>
<th>Matrícula Empréstimo</th>
<th>Data Retirada</th>
<th>Prazo Devolução</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="relatorioBody"></tbody>
</table>
</div>
</main>

<script src="firebaseConfig.js"></script>

<script>
/* ===== ADMIN ===== */
const isAdmin = window.isAdmin === true;

/* ===== STATUS ===== */
function addStatusListener(tr,id,data){
    const btn=tr.querySelector('.statusBtn');
    btn.addEventListener('click', async ()=>{
        const novoStatus = data.status==='em aberto'?'resolvido':'em aberto';
        await db.collection('emprestimos').doc(id).update({status:novoStatus});
        data.status = novoStatus;
        btn.textContent = novoStatus;
        btn.style.background = novoStatus==='em aberto'?'#ff5555':'#55ff55';
    });
}

/* ===== EXCLUIR ===== */
async function excluirEmprestimo(id){
    if(!confirm("⚠️ Tem certeza que deseja excluir este empréstimo?")) return;
    await db.collection("emprestimos").doc(id).delete();
    carregarRelatorio();
}

/* ===== RELATÓRIO ===== */
async function carregarRelatorio(){
    const tbody=document.getElementById('relatorioBody');
    tbody.innerHTML='';

    const snapshot=await db.collection('emprestimos').orderBy('timestamp','desc').get();
    snapshot.forEach(docSnap=>{
        const d=docSnap.data();
        const tr=document.createElement('tr');

        tr.innerHTML=`
            <td>${d.nomeMotorista||''}</td>
            <td>${d.matriculaMotorista||''}</td>
            <td>${d.tipoCartao||''}</td>
            <td>${d.numBordoDigicon||'-'}</td>
            <td>${d.numBordoProdata||'-'}</td>
            <td>${d.numMeiaViagem||'-'}</td>
            <td>${d.motivo||''}</td>
            <td>${d.matriculaEmpresto||''}</td>
            <td>${d.dataRetirada||''}</td>
            <td>${d.prazoDevolucao||'-'}</td>
            <td>
                <button class="statusBtn" style="background:${d.status==='em aberto'?'#ff5555':'#55ff55'}">
                    ${d.status}
                </button>
            </td>
            <td>
                ${isAdmin ? `<button class="deleteBtn">Excluir</button>` : ``}
            </td>
        `;

        tbody.appendChild(tr);
        addStatusListener(tr,docSnap.id,d);

        if(isAdmin){
            tr.querySelector('.deleteBtn')
              .addEventListener('click',()=>excluirEmprestimo(docSnap.id));
        }
    });
}

carregarRelatorio();
</script>

</body>
</html>
